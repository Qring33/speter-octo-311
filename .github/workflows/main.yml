name: Run Neo Bot

on:
  workflow_dispatch:

jobs:
  run-bots:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ---------------------------
      # Create Dockerfile
      # ---------------------------
      - name: Create Dockerfile
        run: |
          cat << 'EOF' > Dockerfile
          FROM debian:12

          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt update -y && apt install -y \
              curl git ca-certificates gnupg \
              xvfb x11-xserver-utils \
              libgl1 libglu1-mesa \
              yt-dlp

          RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
              && apt install -y nodejs \
              && npm install -g npm@latest

          WORKDIR /app
          COPY . .

          WORKDIR /app/jumptask

          RUN if [ ! -f package.json ]; then npm init -y; fi

          RUN npm install playwright playwright-extra adm-zip pg axios --save \
              && npx playwright install-deps \
              && npx playwright install chromium

          ENTRYPOINT ["/bin/bash", "-c", "\
            DISPLAY=:99 Xvfb :99 -screen 0 1920x1080x24 +extension GLX +extension RANDR +render -noreset -ac & \
            sleep 5 && \
            node runner.js \
          "]
          EOF

      # ---------------------------
      # Build image once
      # ---------------------------
      - name: Build Docker image
        run: docker build -t neo-bot-image .

      # ---------------------------
      # Start 5 isolated containers
      # ---------------------------
      - name: Start 5 containers (20s delay)
        run: |
          for i in {1..5}; do
            echo "Starting container $i"

            docker run -d \
              --name neo-bot-$i \
              neo-bot-image

            sleep 20
          done

      # ---------------------------
      # Stream prefixed logs
      # ---------------------------
      - name: Stream logs
        run: |
          for i in {1..5}; do
            docker logs -f neo-bot-$i 2>&1 | sed "s/^/[bot-$i] /" &
          done

          wait

      # ---------------------------
      # Wait for all containers
      # ---------------------------
      - name: Wait for containers
        run: |
          for i in {1..5}; do
            docker wait neo-bot-$i
            echo "neo-bot-$i finished"
          done

          echo "All 5 bots finished."
