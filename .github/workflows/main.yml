name: Run Neo Bot

on:
  workflow_dispatch:

jobs:
  run-bots:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ---------------------------
      # Install system dependencies once
      # ---------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            curl \
            ca-certificates \
            xvfb \
            x11-xserver-utils \
            libgl1 \
            libglu1-mesa \
            yt-dlp \
            git

          which yt-dlp
          yt-dlp --version

      # ---------------------------
      # Set up Node.js once
      # ---------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # ---------------------------
      # Install npm dependencies once
      # ---------------------------
      - name: Install dependencies inside jumptask
        run: |
          cd jumptask

          if [ ! -f package.json ]; then
            npm init -y
          fi

          npm install playwright playwright-extra adm-zip pg axios --save
          npx playwright install-deps
          npx playwright install chromium

      # ---------------------------
      # Run 10 independent bots with prefixed logs
      # ---------------------------
      - name: Start 10 independent bots
        run: |
          cd jumptask

          for i in {1..10}; do
            (
              DISPLAY_NUM=$((99 + i))
              export DISPLAY=:$DISPLAY_NUM

              echo "[bot-$i] Starting on DISPLAY :$DISPLAY_NUM"

              Xvfb :$DISPLAY_NUM -screen 0 1920x1080x24 +extension GLX +extension RANDR +render -noreset -ac &
              XVFB_PID=$!

              sleep 5

              # Run runner.js with logs prefixed
              node runner.js 2>&1 | sed "s/^/[bot-$i] /" || echo "[bot-$i] FAILED"

              kill $XVFB_PID || true

              echo "[bot-$i] Finished"
            ) &

            # 20s delay before starting next bot
            sleep 20
          done

          # Wait for all background bots to finish
          wait

          echo "All 10 bots finished."
