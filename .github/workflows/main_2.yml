name: Run Neo Bot_2

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */5 * * *"   # Every 5 hours (UTC)

jobs:
  run-bots:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ---------------------------
      # Create Dockerfile
      # ---------------------------
      - name: Create Dockerfile
        run: |
          cat << 'EOF' > Dockerfile
          FROM debian:12

          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt update -y && apt install -y \
              curl git ca-certificates gnupg \
              xvfb x11-xserver-utils \
              libgl1 libglu1-mesa \
              yt-dlp

          RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
              && apt install -y nodejs \
              && npm install -g npm@latest

          WORKDIR /app
          COPY . .

          WORKDIR /app/jumptask

          RUN if [ ! -f package.json ]; then npm init -y; fi

          RUN npm install playwright playwright-extra adm-zip pg axios --save \
              && npx playwright install-deps \
              && npx playwright install chromium

          ENTRYPOINT ["/bin/bash", "-c", "\
            export DISPLAY=:99 && \
            Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render & \
            sleep 8 && \
            node runner.js \
          "]
          EOF

      # ---------------------------
      # Build image once
      # ---------------------------
      - name: Build Docker image
        run: docker build -t neo-bot-image .

      # ---------------------------
      # Start 5 isolated containers
      # ---------------------------
      - name: Start 5 containers (20s delay)
        run: |
          for i in {1..5}; do
            echo "Starting container $i"

            docker run -d \
              --name neo-bot-$i \
              --shm-size=1g \
              neo-bot-image

            sleep 20
          done

      # ---------------------------
      # Wait for all containers to finish
      # ---------------------------
      - name: Wait for containers
        run: |
          for i in {1..5}; do
            docker wait neo-bot-$i
            echo "neo-bot-$i finished"
          done

      # ---------------------------
      # Print logs after completion
      # ---------------------------
      - name: Print container logs
        run: |
          for i in {1..5}; do
            echo "======================="
            echo "Logs for bot-$i"
            echo "======================="
            docker logs neo-bot-$i 2>&1 | sed "s/^/[bot-$i] /"
          done

          echo "All 5 bots finished."
